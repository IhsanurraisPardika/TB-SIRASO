<% layout('layouts/layout') -%>

<h1 class="text-3xl font-bold mb-6">Keranjang Belanja</h1>

<% if (items.length === 0) { %>
  <div class="bg-white rounded-lg shadow p-6 text-center">
    <p class="text-gray-600 mb-4">Keranjang belanja Anda kosong.</p>
    <a href="/" class="inline-block px-4 py-2 bg-blue-600 text-white rounded">Kembali ke Menu</a>
  </div>
<% } else { %>
  <div class="bg-white rounded-lg shadow p-6">
    <% items.forEach(item => { %>
      <div class="flex justify-between items-center border-b pb-4 mb-4">
        <div class="flex-1">
          <h3 class="font-semibold"><%= item.menu.nama_makanan %></h3>
          <p class="text-gray-600">Harga: Rp<%= parseFloat(item.menu.harga).toLocaleString('id-ID') %></p>
          <p class="text-gray-600">Subtotal: Rp<%= (parseFloat(item.menu.harga) * item.jumlah).toLocaleString('id-ID') %></p>
          <p class="text-gray-600">Waktu Pengambilan: <%= item.waktu_pengambilan.toLocaleString('id-ID') %></p>
        </div>
        <div class="flex items-center">
          <button class="decrease-btn px-2 py-1 bg-gray-200 rounded" data-id="<%= item.keranjang_id %>">-</button>
          <span class="mx-2 w-8 text-center"><%= item.jumlah %></span>
          <button class="increase-btn px-2 py-1 bg-gray-200 rounded" data-id="<%= item.keranjang_id %>">+</button>
        </div>
        <button class="remove-btn ml-4 px-3 py-1 bg-red-500 text-white rounded" data-id="<%= item.keranjang_id %>">Hapus</button>
      </div>
    <% }); %>
    
    <div class="mt-6 pt-4 border-t">
      <p class="text-xl font-semibold text-right">
        Total: Rp<%= items.reduce((sum, item) => sum + (parseFloat(item.menu.harga) * item.jumlah), 0).toLocaleString('id-ID') %>
      </p>
    </div>
    
    <div class="mt-6 flex justify-between">
      <div>
        <a href="/" class="px-4 py-2 bg-gray-200 rounded">Kembali ke Menu</a>
        <button class="px-4 py-2 bg-red-500 text-white rounded ml-2" id="clearCart">Hapus Semua</button>
      </div>
      <button class="px-4 py-2 bg-green-600 text-white rounded" id="checkout">Checkout</button>
    </div>
  </div>
<% } %>

<!-- Modal Checkout -->
<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden" id="checkoutModal">
  <div class="bg-white rounded-lg p-6 w-full max-w-md">
    <h3 class="text-xl font-semibold mb-4">Checkout</h3>
    <form id="checkoutForm">
      <div class="mb-4">
        <label class="block text-gray-700 mb-2">Metode Pembayaran:</label>
        <select class="w-full px-3 py-2 border rounded" name="metode_pembayaran" required>
          <option value="BNI">BNI</option>
          <option value="Gopay">Gopay</option>
          <option value="Dana">Dana</option>
          <option value="Cash">Cash</option>
        </select>
      </div>
      <div class="mb-4">
        <label class="block text-gray-700 mb-2">Kode Diskon (opsional):</label>
        <input type="text" class="w-full px-3 py-2 border rounded" name="kode_diskon">
      </div>
      <div class="flex justify-end space-x-2">
        <button type="button" class="px-4 py-2 bg-gray-200 rounded" id="cancelCheckout">Batal</button>
        <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded">Konfirmasi</button>
      </div>
    </form>
  </div>
</div>

<script>
  // Implementasi JavaScript untuk keranjang
  document.querySelectorAll('.decrease-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = btn.dataset.id;
      const quantitySpan = btn.nextElementSibling;
      const newQuantity = parseInt(quantitySpan.textContent) - 1;
      
      if (newQuantity < 1) {
        // Hapus item jika quantity 0
        await fetch(`/keranjang/${id}`, { method: 'DELETE' });
        location.reload();
      } else {
        // Update quantity
        await fetch(`/keranjang/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ jumlah: newQuantity })
        });
        quantitySpan.textContent = newQuantity;
        location.reload();
      }
    });
  });
  
  // ... (implementasi lainnya)
</script>